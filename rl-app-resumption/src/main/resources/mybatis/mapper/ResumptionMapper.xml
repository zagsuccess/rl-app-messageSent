<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.uhope.rl.resumption.mapper.ResumptionMapper">
    <!-- 天津市 统计巡查情况 -->

    <!-- 按区为单位统计各级河长应巡次数 -->
    <select id="findNeedPatrolNum"  parameterType="java.util.Map" resultType="com.uhope.rl.resumption.dto.statistics.ReachPatrolNumStatisticDTO">
    SELECT mar.area_code AS regionId, mar.area_name AS regionName, mar.grade as regionGrade,IFNULL(t_ro.needNum,0) as
        <if test="regionGrade == 3">countyNeedPatrolNum</if>
        <if test="regionGrade == 4">townNeedPatrolNum</if>
        <if test="regionGrade == 5">villageNeedPatrolNum</if>
	FROM md_administrative_region mar
    LEFT JOIN
    (
        SELECT CONCAT(LEFT(t_rn.region_code,6),'000000') AS regionStr, SUM(t_rn.needReachNum) as needNum
        FROM
        (
            SELECT t_rm.region_code,
            #{intervalMonths}*count(t_rm.region_code)*IFNULL(achs.patrolMarkMonth,IFNULL(achs.patrolMarkTenDay*3,IFNULL(achs.patrolMarkWeek * 4, IFNULL(achs.patrolMarkDay * 30,0)))) AS needReachNum
                FROM
                (
                    SELECT  mrc.`region_code`,mrc.`id`,mrcm.`CHAIRMANLEVEL`,mrcm.`chairman_role`
                    FROM md_reach mrc,md_reachchairman mrcm
                    WHERE mrc.`id` = mrcm.`REACHID` AND mrcm.CHAIRMANLEVEL=
                    <if test="regionGrade == 3">3</if>
                    <if test="regionGrade == 4">4</if>
                    <if test="regionGrade == 5">5</if>
                )t_rm
            LEFT JOIN am_check_standard achs ON t_rm.CHAIRMANLEVEL = achs.roleLevel AND t_rm.chairman_role = achs.roleId
            GROUP BY t_rm.region_code
            )t_rn GROUP BY regionStr
    )t_ro ON t_ro.regionStr=mar.area_code WHERE mar.grade=3
        <if test="regionId != null">
            AND t_ro.regionStr=#{regionId}
        </if>
    </select>

    <!-- 按区为单位统计各级河长已巡次数 -->
    <select id="findHadPatrolNum"  parameterType="java.util.Map" resultType="com.uhope.rl.resumption.dto.statistics.ReachPatrolNumStatisticDTO">
    SELECT mar.area_code AS regionId, mar.area_name AS regionName, mar.grade as regionGrade,IFNULL(t_ro.hadNum,0) as
    <if test="regionGrade == 3">countyHasPatrolNum</if>
    <if test="regionGrade == 4">townHasPatrolNum</if>
    <if test="regionGrade == 5">villageHasPatrolNum</if>
    FROM md_administrative_region mar
        LEFT JOIN
        (
            SELECT CONCAT(LEFT(t_rn.regionStr,6),'000000') AS regionStr, SUM(t_rn.hadNum) as hadNum
            FROM
            (
                SELECT mr.region_code AS regionStr, t_n.hadNum, mr.grade
                FROM
                (
                    SELECT mlc.REACHID,COUNT(mlc.REACHID) as hadNum
                    FROM md_locusrecord mlc
                    WHERE 1=1
                    <if test="startTime != null">
                        <![CDATA[
                     AND   mlc.`CREATETIME` >= #{startTime}
                    ]]>
                    </if>
                    <if test="endTime != null">
                        <![CDATA[
                     AND   mlc.`CREATETIME` <= #{endTime}
                    ]]>
                    </if>
                    GROUP BY mlc.REACHID
                )t_n
                LEFT JOIN md_reach mr ON mr.id=t_n.REACHID
                WHERE mr.grade=
                <if test="regionGrade == 3">3</if>
                <if test="regionGrade == 4">4</if>
                <if test="regionGrade == 5">5</if>
            )t_rn GROUP BY regionStr
        )t_ro ON t_ro.regionStr=mar.area_code WHERE mar.grade=3
        <if test="regionId != null">
            AND t_ro.regionStr=#{regionId}
        </if>
    </select>

    <!-- 查找各级河长各自的巡河情况 -->
    <select id="findPersonPatrolNum" parameterType="java.util.Map"  resultType="com.uhope.rl.resumption.dto.statistics.ReachmanPatrolNumStatisticDTO">
    SELECT t_all.chairman_name AS reachmanName, t_all.CHAIRMANLEVEL as reachmanLevel, t_all.needReachNum AS needReachNum, t_all.hadReachNum AS hadReachNum
    FROM
    (
        SELECT CONCAT(LEFT(t_rn.region_code,6),'000000') AS regionStr,t_rn.chairman_name, t_rn.CHAIRMANLEVEL,  t_rn.needReachNum, IFNULL(t_ur.hadReachNum,0) AS hadReachNum
        FROM
        (
            SELECT t_rm.region_code,t_rm.CHAIRMANID, t_rm.chairman_name,t_rm.CHAIRMANLEVEL,
                   #{intervalMonths}*t_rm.num*IFNULL(achs.patrolMarkMonth,IFNULL(achs.patrolMarkTenDay*3,IFNULL(achs.patrolMarkWeek * 4, IFNULL(achs.patrolMarkDay * 30,0)))) AS needReachNum
            FROM
            (
                SELECT mr.region_code,COUNT(0) as num, mrcm.chairman_name, mrcm.REACHID, mrcm.CHAIRMANLEVEL,  mrcm.chairman_role,mrcm.CHAIRMANID
                FROM md_reachchairman mrcm, md_reach mr
                WHERE mrcm.chairmanlevel=#{regionGrade} AND mr.id=mrcm.REACHID
                GROUP BY mrcm.CHAIRMANID
            )t_rm
            LEFT JOIN am_check_standard achs ON t_rm.CHAIRMANLEVEL = achs.roleLevel AND t_rm.chairman_role = achs.roleId
        )t_rn
        LEFT JOIN
        (
            SELECT mlr.USERID,COUNT(0) AS hadReachNum
            FROM md_locusrecord mlr
            WHERE 1=1
            <if test="startTime != null">
                <![CDATA[
                 AND   mlr.`CREATETIME` >= #{startTime}
                ]]>
            </if>
            <if test="endTime != null">
                <![CDATA[
                 AND   mlr.`CREATETIME` <= #{endTime}
                ]]>
            </if>
            GROUP BY mlr.USERID
        )t_ur ON t_rn.CHAIRMANID=t_ur.USERID
    )t_all
    WHERE regionStr=#{regionId};
    </select>
</mapper>